const axios = require('axios');

async function runComprehensiveTests() {
  console.log('ðŸ§ª è¿è¡Œç»¼åˆåŠŸèƒ½æµ‹è¯•å¥—ä»¶...\n');
  
  const API_BASE = 'http://localhost:5000/api';
  const timestamp = Date.now().toString().slice(-6);
  let token = '';
  let userId = '';
  let petId = '';
  let postId = '';
  
  const testResults = {
    healthCheck: false,
    userAuth: false,
    petManagement: false,
    communityFeatures: false,
    analysisRecords: false,
    errorHandling: false,
    dataValidation: false
  };
  
  try {
    // 1. ç³»ç»Ÿå¥åº·æ£€æŸ¥
    console.log('1. ðŸ¥ ç³»ç»Ÿå¥åº·æ£€æŸ¥...');
    const healthResponse = await axios.get(`${API_BASE}/health`);
    console.log('âœ… ç³»ç»Ÿå¥åº·çŠ¶æ€æ­£å¸¸');
    console.log(`   æ•°æ®åº“: ${healthResponse.data.database}`);
    console.log(`   ç¼“å­˜: ${healthResponse.data.cache}`);
    console.log(`   æ—¶é—´æˆ³: ${healthResponse.data.timestamp}`);
    testResults.healthCheck = true;
    
    // 2. ç”¨æˆ·è®¤è¯ç³»ç»Ÿæµ‹è¯•
    console.log('\n2. ðŸ‘¤ ç”¨æˆ·è®¤è¯ç³»ç»Ÿæµ‹è¯•...');
    
    // æ³¨å†Œç”¨æˆ·
    const registerData = {
      username: `user${timestamp}`,
      email: `test${timestamp}@example.com`,
      password: 'abc123456',
      confirmPassword: 'abc123456'
    };
    
    const registerResponse = await axios.post(`${API_BASE}/auth/register`, registerData);
    token = registerResponse.data.data.tokens.accessToken;
    userId = registerResponse.data.data.user.id;
    console.log('âœ… ç”¨æˆ·æ³¨å†ŒæˆåŠŸ');
    
    // ç™»å½•éªŒè¯
    const loginResponse = await axios.post(`${API_BASE}/auth/login`, {
      email: registerData.email,
      password: registerData.password
    });
    console.log('âœ… ç”¨æˆ·ç™»å½•éªŒè¯æˆåŠŸ');
    
    // èŽ·å–ç”¨æˆ·ä¿¡æ¯
    const userInfoResponse = await axios.get(`${API_BASE}/auth/me`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    console.log('âœ… ç”¨æˆ·ä¿¡æ¯èŽ·å–æˆåŠŸ');
    console.log(`   ç”¨æˆ·ID: ${userInfoResponse.data.data.user.id}`);
    console.log(`   ç”¨æˆ·å: ${userInfoResponse.data.data.user.username}`);
    testResults.userAuth = true;
    
    // 3. å® ç‰©ç®¡ç†åŠŸèƒ½æµ‹è¯•
    console.log('\n3. ðŸ• å® ç‰©ç®¡ç†åŠŸèƒ½æµ‹è¯•...');
    
    // åˆ›å»ºå® ç‰©
    const petData = {
      name: 'æµ‹è¯•å® ç‰©',
      type: 'dog',
      breed: 'é‡‘æ¯›å¯»å›žçŠ¬',
      age: 3,
      weight: 28.5,
      gender: 'female',
      description: 'å‹å–„æ´»æ³¼çš„é‡‘æ¯›çŠ¬'
    };
    
    const petResponse = await axios.post(`${API_BASE}/pets`, petData, {
      headers: { Authorization: `Bearer ${token}` }
    });
    petId = petResponse.data.data.id;
    console.log('âœ… å® ç‰©åˆ›å»ºæˆåŠŸ');
    console.log(`   å® ç‰©ID: ${petId}`);
    
    // èŽ·å–å® ç‰©åˆ—è¡¨
    const petsListResponse = await axios.get(`${API_BASE}/pets`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    console.log(`âœ… å® ç‰©åˆ—è¡¨èŽ·å–æˆåŠŸ (${petsListResponse.data.data.pets.length} åªå® ç‰©)`);
    
    // æ›´æ–°å® ç‰©ä¿¡æ¯
    const updatePetResponse = await axios.put(`${API_BASE}/pets/${petId}`, {
      ...petData,
      age: 4,
      description: 'æ›´æ–°åŽçš„å® ç‰©æè¿°'
    }, {
      headers: { Authorization: `Bearer ${token}` }
    });
    console.log('âœ… å® ç‰©ä¿¡æ¯æ›´æ–°æˆåŠŸ');
    testResults.petManagement = true;
    
    // 4. ç¤¾åŒºåŠŸèƒ½æµ‹è¯•
    console.log('\n4. ðŸ‘¥ ç¤¾åŒºåŠŸèƒ½æµ‹è¯•...');
    
    // èŽ·å–ç¤¾åŒºå¸–å­
    const postsResponse = await axios.get(`${API_BASE}/community/posts`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    console.log(`âœ… ç¤¾åŒºå¸–å­èŽ·å–æˆåŠŸ (${postsResponse.data.data.posts.length} ä¸ªå¸–å­)`);
    
    if (postsResponse.data.data.posts.length > 0) {
      postId = postsResponse.data.data.posts[0]._id;
      
      // æµ‹è¯•ç‚¹èµžåŠŸèƒ½
      const likeResponse = await axios.post(`${API_BASE}/community/posts/${postId}/like`, {}, {
        headers: { Authorization: `Bearer ${token}` }
      });
      console.log('âœ… å¸–å­ç‚¹èµžåŠŸèƒ½æ­£å¸¸');
      
      // èŽ·å–è¯„è®º
      const commentsResponse = await axios.get(`${API_BASE}/community/posts/${postId}/comments`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      console.log(`âœ… è¯„è®ºèŽ·å–æˆåŠŸ (${commentsResponse.data.data.comments.length} æ¡è¯„è®º)`);
    }
    testResults.communityFeatures = true;
    
    // 5. åˆ†æžè®°å½•æµ‹è¯•
    console.log('\n5. ðŸ“Š åˆ†æžè®°å½•æµ‹è¯•...');
    
    const recordsResponse = await axios.get(`${API_BASE}/records`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    console.log(`âœ… åˆ†æžè®°å½•èŽ·å–æˆåŠŸ (${recordsResponse.data.data.records.length} æ¡è®°å½•)`);
    
    // èŽ·å–ç»Ÿè®¡æ•°æ®
    const statsResponse = await axios.get(`${API_BASE}/records/statistics/overview`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    console.log('âœ… ç»Ÿè®¡æ•°æ®èŽ·å–æˆåŠŸ');
    testResults.analysisRecords = true;
    
    // 6. é”™è¯¯å¤„ç†æµ‹è¯•
    console.log('\n6. âš ï¸  é”™è¯¯å¤„ç†æµ‹è¯•...');
    
    try {
      // æµ‹è¯•æ— æ•ˆä»¤ç‰Œ
      await axios.get(`${API_BASE}/auth/me`, {
        headers: { Authorization: 'Bearer invalid-token' }
      });
    } catch (error) {
      if (error.response?.status === 401) {
        console.log('âœ… æ— æ•ˆä»¤ç‰Œé”™è¯¯å¤„ç†æ­£å¸¸');
      }
    }
    
    try {
      // æµ‹è¯•è®¿é—®ä¸å­˜åœ¨çš„èµ„æº
      await axios.get(`${API_BASE}/pets/nonexistent-id`, {
        headers: { Authorization: `Bearer ${token}` }
      });
    } catch (error) {
      if (error.response?.status === 404) {
        console.log('âœ… 404é”™è¯¯å¤„ç†æ­£å¸¸');
      }
    }
    testResults.errorHandling = true;
    
    // 7. æ•°æ®éªŒè¯æµ‹è¯•
    console.log('\n7. ðŸ” æ•°æ®éªŒè¯æµ‹è¯•...');
    
    try {
      // æµ‹è¯•æ— æ•ˆçš„å® ç‰©æ•°æ®
      await axios.post(`${API_BASE}/pets`, {
        name: '', // ç©ºåç§°
        type: 'invalid-type',
        age: -1 // æ— æ•ˆå¹´é¾„
      }, {
        headers: { Authorization: `Bearer ${token}` }
      });
    } catch (error) {
      if (error.response?.status === 400) {
        console.log('âœ… æ•°æ®éªŒè¯é”™è¯¯å¤„ç†æ­£å¸¸');
      }
    }
    
    try {
      // æµ‹è¯•é‡å¤ç”¨æˆ·æ³¨å†Œ
      await axios.post(`${API_BASE}/auth/register`, registerData);
    } catch (error) {
      if (error.response?.status === 400) {
        console.log('âœ… é‡å¤æ³¨å†ŒéªŒè¯æ­£å¸¸');
      }
    }
    testResults.dataValidation = true;
    
    // æµ‹è¯•ç»“æžœæ±‡æ€»
    console.log('\nðŸ“Š ç»¼åˆæµ‹è¯•ç»“æžœæ±‡æ€»:');
    Object.entries(testResults).forEach(([test, result]) => {
      const status = result ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
      const testName = {
        healthCheck: 'ç³»ç»Ÿå¥åº·æ£€æŸ¥',
        userAuth: 'ç”¨æˆ·è®¤è¯ç³»ç»Ÿ',
        petManagement: 'å® ç‰©ç®¡ç†åŠŸèƒ½',
        communityFeatures: 'ç¤¾åŒºåŠŸèƒ½',
        analysisRecords: 'åˆ†æžè®°å½•',
        errorHandling: 'é”™è¯¯å¤„ç†',
        dataValidation: 'æ•°æ®éªŒè¯'
      }[test];
      console.log(`${status} ${testName}`);
    });
    
    const passedTests = Object.values(testResults).filter(result => result).length;
    const totalTests = Object.keys(testResults).length;
    
    console.log(`\nðŸŽ¯ æµ‹è¯•é€šè¿‡çŽ‡: ${passedTests}/${totalTests} (${Math.round(passedTests/totalTests*100)}%)`);
    
    if (passedTests === totalTests) {
      console.log('\nðŸŽ‰ æ‰€æœ‰ç»¼åˆæµ‹è¯•é€šè¿‡ï¼ç³»ç»ŸåŠŸèƒ½å®Œæ•´ä¸”ç¨³å®šã€‚');
      console.log('\nðŸ“‹ å·²éªŒè¯çš„åŠŸèƒ½æ¨¡å—:');
      console.log('   âœ… ç³»ç»Ÿç›‘æŽ§å’Œå¥åº·æ£€æŸ¥');
      console.log('   âœ… å®Œæ•´çš„ç”¨æˆ·è®¤è¯æµç¨‹');
      console.log('   âœ… å® ç‰©ä¿¡æ¯CRUDæ“ä½œ');
      console.log('   âœ… ç¤¾åŒºäº’åŠ¨å’Œå†…å®¹ç®¡ç†');
      console.log('   âœ… æ•°æ®åˆ†æžå’Œç»Ÿè®¡æŠ¥å‘Š');
      console.log('   âœ… é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ¢å¤');
      console.log('   âœ… è¾“å…¥éªŒè¯å’Œå®‰å…¨é˜²æŠ¤');
      
      console.log('\nðŸ”— ç³»ç»Ÿè®¿é—®ä¿¡æ¯:');
      console.log('   åŽç«¯API: http://localhost:5000/api');
      console.log('   å¥åº·æ£€æŸ¥: http://localhost:5000/api/health');
      console.log('   APIæ–‡æ¡£: æŸ¥çœ‹README.mdä¸­çš„APIæŽ¥å£è¯´æ˜Ž');
    } else {
      console.log('\nâš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç›¸å…³åŠŸèƒ½æ¨¡å—ã€‚');
    }
    
  } catch (error) {
    console.log('\nâŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºçŽ°ä¸¥é‡é”™è¯¯:');
    console.log('é”™è¯¯ä¿¡æ¯:', error.response?.data?.message || error.message);
    console.log('çŠ¶æ€ç :', error.response?.status);
    if (error.response?.data?.errors) {
      console.log('è¯¦ç»†é”™è¯¯:');
      error.response.data.errors.forEach((err, index) => {
        console.log(`  ${index + 1}. ${err.field}: ${err.message}`);
      });
    }
  }
}

runComprehensiveTests();