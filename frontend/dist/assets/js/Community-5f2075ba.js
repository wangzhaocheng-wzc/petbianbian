import{j as e,a as t,u as a,F as r}from"./index-379b094b.js";import{r as s}from"./react-vendor-7927b0b6.js";import{a as n,O as l,z as i,q as o,p as c,u as d,g as m,y as g,F as u,R as h,N as p,Q as x,V as y,Y as b,Z as v,I as f,X as N,j as w,o as k,_ as C,$ as P,w as S}from"./ui-vendor-f43192ea.js";import{b as z,i as $,c as j,d as L,e as E,f as I,a as M}from"./utils-2ce30174.js";import{u as W}from"./usePets-2d4c1e5f.js";import"./router-2b5ad94b.js";import"./api-f70ec57c.js";const T={lessThanXSeconds:{one:"不到 1 秒",other:"不到 {{count}} 秒"},xSeconds:{one:"1 秒",other:"{{count}} 秒"},halfAMinute:"半分钟",lessThanXMinutes:{one:"不到 1 分钟",other:"不到 {{count}} 分钟"},xMinutes:{one:"1 分钟",other:"{{count}} 分钟"},xHours:{one:"1 小时",other:"{{count}} 小时"},aboutXHours:{one:"大约 1 小时",other:"大约 {{count}} 小时"},xDays:{one:"1 天",other:"{{count}} 天"},aboutXWeeks:{one:"大约 1 个星期",other:"大约 {{count}} 个星期"},xWeeks:{one:"1 个星期",other:"{{count}} 个星期"},aboutXMonths:{one:"大约 1 个月",other:"大约 {{count}} 个月"},xMonths:{one:"1 个月",other:"{{count}} 个月"},aboutXYears:{one:"大约 1 年",other:"大约 {{count}} 年"},xYears:{one:"1 年",other:"{{count}} 年"},overXYears:{one:"超过 1 年",other:"超过 {{count}} 年"},almostXYears:{one:"将近 1 年",other:"将近 {{count}} 年"}},U={date:z({formats:{full:"y'年'M'月'd'日' EEEE",long:"y'年'M'月'd'日'",medium:"yyyy-MM-dd",short:"yy-MM-dd"},defaultWidth:"full"}),time:z({formats:{full:"zzzz a h:mm:ss",long:"z a h:mm:ss",medium:"a h:mm:ss",short:"a h:mm"},defaultWidth:"full"}),dateTime:z({formats:{full:"{{date}} {{time}}",long:"{{date}} {{time}}",medium:"{{date}} {{time}}",short:"{{date}} {{time}}"},defaultWidth:"full"})};function D(e,t,a){const r="eeee p";return $(e,t,a)?r:e.getTime()>t.getTime()?"'下个'"+r:"'上个'"+r}const R={lastWeek:D,yesterday:"'昨天' p",today:"'今天' p",tomorrow:"'明天' p",nextWeek:D,other:"PP p"},A={code:"zh-CN",formatDistance:(e,t,a)=>{let r;const s=T[e];return r="string"==typeof s?s:1===t?s.one:s.other.replace("{{count}}",String(t)),(null==a?void 0:a.addSuffix)?a.comparison&&a.comparison>0?r+"内":r+"前":r},formatLong:U,formatRelative:(e,t,a,r)=>{const s=R[e];return"function"==typeof s?s(t,a,r):s},localize:{ordinalNumber:(e,t)=>{const a=Number(e);switch(null==t?void 0:t.unit){case"date":return a.toString()+"日";case"hour":return a.toString()+"时";case"minute":return a.toString()+"分";case"second":return a.toString()+"秒";default:return"第 "+a.toString()}},era:j({values:{narrow:["前","公元"],abbreviated:["前","公元"],wide:["公元前","公元"]},defaultWidth:"wide"}),quarter:j({values:{narrow:["1","2","3","4"],abbreviated:["第一季","第二季","第三季","第四季"],wide:["第一季度","第二季度","第三季度","第四季度"]},defaultWidth:"wide",argumentCallback:e=>e-1}),month:j({values:{narrow:["一","二","三","四","五","六","七","八","九","十","十一","十二"],abbreviated:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],wide:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"]},defaultWidth:"wide"}),day:j({values:{narrow:["日","一","二","三","四","五","六"],short:["日","一","二","三","四","五","六"],abbreviated:["周日","周一","周二","周三","周四","周五","周六"],wide:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"]},defaultWidth:"wide"}),dayPeriod:j({values:{narrow:{am:"上",pm:"下",midnight:"凌晨",noon:"午",morning:"早",afternoon:"下午",evening:"晚",night:"夜"},abbreviated:{am:"上午",pm:"下午",midnight:"凌晨",noon:"中午",morning:"早晨",afternoon:"中午",evening:"晚上",night:"夜间"},wide:{am:"上午",pm:"下午",midnight:"凌晨",noon:"中午",morning:"早晨",afternoon:"中午",evening:"晚上",night:"夜间"}},defaultWidth:"wide",formattingValues:{narrow:{am:"上",pm:"下",midnight:"凌晨",noon:"午",morning:"早",afternoon:"下午",evening:"晚",night:"夜"},abbreviated:{am:"上午",pm:"下午",midnight:"凌晨",noon:"中午",morning:"早晨",afternoon:"中午",evening:"晚上",night:"夜间"},wide:{am:"上午",pm:"下午",midnight:"凌晨",noon:"中午",morning:"早晨",afternoon:"中午",evening:"晚上",night:"夜间"}},defaultFormattingWidth:"wide"})},match:{ordinalNumber:L({matchPattern:/^(第\s*)?\d+(日|时|分|秒)?/i,parsePattern:/\d+/i,valueCallback:e=>parseInt(e,10)}),era:E({matchPatterns:{narrow:/^(前)/i,abbreviated:/^(前)/i,wide:/^(公元前|公元)/i},defaultMatchWidth:"wide",parsePatterns:{any:[/^(前)/i,/^(公元)/i]},defaultParseWidth:"any"}),quarter:E({matchPatterns:{narrow:/^[1234]/i,abbreviated:/^第[一二三四]刻/i,wide:/^第[一二三四]刻钟/i},defaultMatchWidth:"wide",parsePatterns:{any:[/(1|一)/i,/(2|二)/i,/(3|三)/i,/(4|四)/i]},defaultParseWidth:"any",valueCallback:e=>e+1}),month:E({matchPatterns:{narrow:/^(一|二|三|四|五|六|七|八|九|十[二一])/i,abbreviated:/^(一|二|三|四|五|六|七|八|九|十[二一]|\d|1[12])月/i,wide:/^(一|二|三|四|五|六|七|八|九|十[二一])月/i},defaultMatchWidth:"wide",parsePatterns:{narrow:[/^一/i,/^二/i,/^三/i,/^四/i,/^五/i,/^六/i,/^七/i,/^八/i,/^九/i,/^十(?!(一|二))/i,/^十一/i,/^十二/i],any:[/^一|1/i,/^二|2/i,/^三|3/i,/^四|4/i,/^五|5/i,/^六|6/i,/^七|7/i,/^八|8/i,/^九|9/i,/^十(?!(一|二))|10/i,/^十一|11/i,/^十二|12/i]},defaultParseWidth:"any"}),day:E({matchPatterns:{narrow:/^[一二三四五六日]/i,short:/^[一二三四五六日]/i,abbreviated:/^周[一二三四五六日]/i,wide:/^星期[一二三四五六日]/i},defaultMatchWidth:"wide",parsePatterns:{any:[/日/i,/一/i,/二/i,/三/i,/四/i,/五/i,/六/i]},defaultParseWidth:"any"}),dayPeriod:E({matchPatterns:{any:/^(上午?|下午?|午夜|[中正]午|早上?|下午|晚上?|凌晨|)/i},defaultMatchWidth:"any",parsePatterns:{any:{am:/^上午?/i,pm:/^下午?/i,midnight:/^午夜/i,noon:/^[中正]午/i,morning:/^早上/i,afternoon:/^下午/i,evening:/^晚上?/i,night:/^凌晨/i}},defaultParseWidth:"any"})},options:{weekStartsOn:1,firstWeekContainsDate:4}},_=({isLiked:a,likesCount:r,onToggle:l,size:i="md",disabled:o=!1,className:c=""})=>{const[d,m]=s.useState(!1);return e("button",{onClick:async e=>{if(e.stopPropagation(),!o&&!d){m(!0);try{await l()}catch(t){}finally{m(!1)}}},disabled:o||d,className:`\n        flex items-center space-x-1 transition-colors duration-200\n        ${(()=>{switch(i){case"sm":return"text-xs";case"lg":return"text-base";default:return"text-sm"}})()}\n        ${a?"text-red-600 hover:text-red-700":"text-gray-500 hover:text-red-600"}\n        ${o||d?"opacity-50 cursor-not-allowed":"cursor-pointer"}\n        ${c}\n      `,children:[t(n,{size:(()=>{switch(i){case"sm":return 14;case"lg":return 20;default:return 16}})(),className:`\n          transition-all duration-200\n          ${a?"fill-current scale-110":""}\n          ${d?"animate-pulse":""}\n        `}),t("span",{className:"font-medium",children:d?"...":r})]})},F=({post:a,currentUserId:r,onLike:n,onComment:g,onShare:u,onEdit:h,onDelete:p,onClick:x,className:y=""})=>{var b,v,f,N,w,k,C;const[P,S]=s.useState(!1),[z,$]=s.useState({}),j=r===a.userId,L=!!r&&a.interactions.likes.includes(r);return e("div",{className:`bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow ${y}`,children:[t("div",{className:"p-4",children:e("div",{className:"flex items-start justify-between",children:[e("div",{className:"flex items-center space-x-3",children:[t("div",{className:"w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center",children:(null==(b=a.user)?void 0:b.avatar)?t("img",{src:a.user.avatar,alt:a.user.username,className:"w-10 h-10 rounded-full object-cover"}):t("span",{className:"text-orange-600 font-medium",children:(null==(N=null==(f=null==(v=a.user)?void 0:v.username)?void 0:f.charAt(0))?void 0:N.toUpperCase())||"U"})}),e("div",{className:"flex-1",children:[e("div",{className:"flex items-center space-x-2",children:[t("h4",{className:"font-medium text-gray-900",children:(null==(w=a.user)?void 0:w.username)||"匿名用户"}),(null==(C=null==(k=a.user)?void 0:k.stats)?void 0:C.reputation)&&a.user.stats.reputation>0&&e("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full",children:["声望 ",a.user.stats.reputation]})]}),e("div",{className:"flex items-center space-x-2 mt-1",children:[t("span",{className:"text-sm text-gray-500",children:I(new Date(a.createdAt),{addSuffix:!0,locale:A})}),t("span",{className:`text-xs px-2 py-0.5 rounded-full ${(e=>{const t={health:"bg-green-100 text-green-800",help:"bg-blue-100 text-blue-800",experience:"bg-purple-100 text-purple-800",general:"bg-gray-100 text-gray-800"};return t[e]||t.general})(a.category)}`,children:(E=a.category,{health:"健康分享",help:"求助问答",experience:"经验分享",general:"日常分享"}[E]||"日常分享")}),a.isSticky&&t("span",{className:"text-xs bg-red-100 text-red-800 px-2 py-0.5 rounded-full",children:"置顶"}),a.isFeatured&&t("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full",children:"精选"})]}),a.pet&&e("div",{className:"flex items-center space-x-1 mt-1",children:[t("span",{className:"text-xs text-gray-500",children:"关于"}),t("span",{className:"text-xs text-orange-600 font-medium",children:a.pet.name}),e("span",{className:"text-xs text-gray-400",children:["(","dog"===a.pet.type?"狗":"cat"===a.pet.type?"猫":"其他",")"]})]})]})]}),(j||u)&&e("div",{className:"relative",children:[t("button",{onClick:e=>{e.stopPropagation(),S(!P)},className:"p-1 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100",children:t(l,{size:16})}),P&&e("div",{className:"absolute right-0 top-8 w-32 bg-white border border-gray-200 rounded-lg shadow-lg z-10",children:[j&&h&&e("button",{onClick:e=>{e.stopPropagation(),h(a),S(!1)},className:"w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center",children:[t(i,{size:14,className:"mr-2"}),"编辑"]}),j&&p&&e("button",{onClick:e=>{e.stopPropagation(),confirm("确定要删除这个帖子吗？")&&p(a.id),S(!1)},className:"w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center",children:[t(o,{size:14,className:"mr-2"}),"删除"]}),u&&e("button",{onClick:e=>{e.stopPropagation(),u(a.id),S(!1)},className:"w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center",children:[t(c,{size:14,className:"mr-2"}),"分享"]})]})]})]})}),e("div",{className:"px-4 cursor-pointer",onClick:()=>null==x?void 0:x(a.id),children:[t("h3",{className:"text-lg font-semibold text-gray-900 mb-2 line-clamp-2",children:a.title}),e("div",{className:"text-gray-700 text-sm line-clamp-3 mb-3",children:[a.content.replace(/[#*`\[\]()]/g,"").substring(0,200),a.content.length>200&&"..."]}),a.tags&&a.tags.length>0&&e("div",{className:"flex flex-wrap gap-1 mb-3",children:[a.tags.slice(0,5).map((t,a)=>e("span",{className:"text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full",children:["#",t]},a)),a.tags.length>5&&e("span",{className:"text-xs text-gray-400",children:["+",a.tags.length-5]})]}),(()=>{if(!a.images||0===a.images.length)return null;const r=a.images.filter(e=>!z[e]);if(0===r.length)return null;return t("div",{className:"grid gap-2 mt-3 "+(s=r.length,1===s?"grid-cols-1":2===s||s<=4?"grid-cols-2":"grid-cols-3"),children:r.slice(0,9).map((a,s)=>e("div",{className:"relative aspect-square bg-gray-100 rounded-lg overflow-hidden",children:[t("img",{src:a,alt:`图片 ${s+1}`,className:"w-full h-full object-cover hover:scale-105 transition-transform cursor-pointer",onError:()=>(e=>{$(t=>({...t,[e]:!0}))})(a),onClick:e=>{e.stopPropagation()}}),8===s&&r.length>9&&e("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white font-medium",children:["+",r.length-9]})]},s))});var s})()]}),t("div",{className:"px-4 py-3 border-t border-gray-100",children:e("div",{className:"flex items-center justify-between",children:[e("div",{className:"flex items-center space-x-4",children:[t(_,{isLiked:L,likesCount:a.likesCount||a.interactions.likes.length,onToggle:async()=>{r?await(null==n?void 0:n(a.id)):alert("请先登录")},size:"sm"}),e("button",{onClick:e=>{e.stopPropagation(),null==g||g(a.id)},className:"flex items-center space-x-1 text-sm text-gray-500 hover:text-blue-600 transition-colors",children:[t(d,{size:16}),t("span",{children:a.commentsCount||a.comments.length})]}),u&&e("button",{onClick:e=>{e.stopPropagation(),u(a.id)},className:"flex items-center space-x-1 text-sm text-gray-500 hover:text-green-600 transition-colors",children:[t(c,{size:16}),t("span",{children:a.interactions.shares})]})]}),e("div",{className:"flex items-center space-x-1 text-sm text-gray-400",children:[t(m,{size:14}),t("span",{children:a.interactions.views})]})]})}),P&&t("div",{className:"fixed inset-0 z-5",onClick:()=>S(!1)})]});var E},X=M.create({baseURL:"http://localhost:5000/api",headers:{"Content-Type":"application/json"}});X.interceptors.request.use(e=>{const t=localStorage.getItem("accessToken");return t&&(e.headers.Authorization=`Bearer ${t}`),e}),X.interceptors.response.use(e=>e,e=>{var t;return 401===(null==(t=e.response)?void 0:t.status)&&(localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),window.location.href="/login"),Promise.reject(e)});const B={getPosts:async(e={})=>(await X.get("/community/posts",{params:e})).data,getPost:async e=>(await X.get(`/community/posts/${e}`)).data,createPost:async e=>(await X.post("/community/posts",e)).data,updatePost:async(e,t)=>(await X.put(`/community/posts/${e}`,t)).data,deletePost:async e=>(await X.delete(`/community/posts/${e}`)).data,toggleLikePost:async e=>(await X.post(`/community/posts/${e}/like`)).data,getComments:async(e,t=1,a=20)=>(await X.get(`/community/posts/${e}/comments`,{params:{page:t,limit:a}})).data,createComment:async(e,t)=>(await X.post(`/community/posts/${e}/comments`,t)).data,toggleLikeComment:async e=>(await X.post(`/community/comments/${e}/like`)).data,deleteComment:async e=>(await X.delete(`/community/comments/${e}`)).data,async uploadImage(e){const t=new FormData;t.append("image",e);return(await X.post("/upload/image",t,{headers:{"Content-Type":"multipart/form-data"}})).data}},q=()=>{const[e,t]=s.useState([]),[a,r]=s.useState(!1),[n,l]=s.useState(null),[i,o]=s.useState({current:1,total:0,pageSize:10,totalItems:0}),[c,d]=s.useState([]);return{posts:e,loading:a,error:n,pagination:i,categories:c,fetchPosts:s.useCallback(async(e={})=>{var a,s;r(!0),l(null);try{const a=await B.getPosts(e);a.success&&a.data?(t(a.data.posts),o(a.data.pagination),d(a.data.categories)):l(a.message||"获取帖子列表失败")}catch(n){l((null==(s=null==(a=n.response)?void 0:a.data)?void 0:s.message)||"获取帖子列表失败")}finally{r(!1)}},[]),createPost:s.useCallback(async e=>{var a,s;r(!0),l(null);try{const a=await B.createPost(e);if(a.success&&a.data)return t(e=>[a.data,...e]),a.data;throw new Error(a.message||"创建帖子失败")}catch(n){const e=(null==(s=null==(a=n.response)?void 0:a.data)?void 0:s.message)||n.message||"创建帖子失败";throw l(e),new Error(e)}finally{r(!1)}},[]),updatePost:s.useCallback(async(e,a)=>{var s,n;r(!0),l(null);try{const r=await B.updatePost(e,a);if(r.success&&r.data)return t(t=>t.map(t=>t.id===e?r.data:t)),r.data;throw new Error(r.message||"更新帖子失败")}catch(i){const e=(null==(n=null==(s=i.response)?void 0:s.data)?void 0:n.message)||i.message||"更新帖子失败";throw l(e),new Error(e)}finally{r(!1)}},[]),deletePost:s.useCallback(async e=>{var a,s;r(!0),l(null);try{const a=await B.deletePost(e);if(a.success)return t(t=>t.filter(t=>t.id!==e)),!0;throw new Error(a.message||"删除帖子失败")}catch(n){const e=(null==(s=null==(a=n.response)?void 0:a.data)?void 0:s.message)||n.message||"删除帖子失败";throw l(e),new Error(e)}finally{r(!1)}},[]),toggleLikePost:s.useCallback(async e=>{var a,r;try{const a=await B.toggleLikePost(e);if(a.success&&a.data)return t(t=>t.map(t=>t.id===e?{...t,likesCount:a.data.likesCount,interactions:{...t.interactions,likes:a.data.isLiked?[...t.interactions.likes,"current-user"]:t.interactions.likes.filter(e=>"current-user"!==e)}}:t)),a.data;throw new Error(a.message||"点赞操作失败")}catch(s){const e=(null==(r=null==(a=s.response)?void 0:a.data)?void 0:r.message)||s.message||"点赞操作失败";throw l(e),new Error(e)}},[]),clearError:()=>l(null)}},H=({onCreatePost:r,onEditPost:n,onViewPost:l,className:i=""})=>{const{user:o}=a(),{posts:c,loading:d,error:m,pagination:x,categories:y,fetchPosts:b,deletePost:v,toggleLikePost:f,clearError:N}=q(),[w,k]=s.useState({page:1,limit:10,category:"all",sort:"latest"}),[C,P]=s.useState(""),[S,z]=s.useState(!1),[$,j]=s.useState([]),L=s.useCallback(e=>{const t={...w,...e};C.trim()&&(t.search=C.trim()),$.length>0&&(t.tags=$),b(t)},[w,C,$,b]);s.useEffect(()=>{L()},[]);const E=()=>{k(e=>({...e,page:1})),L({page:1})},I=e=>{const t={...w,page:e};k(t),L(t),window.scrollTo({top:0,behavior:"smooth"})},M=async e=>{if(o)try{await f(e)}catch(t){}else alert("请先登录")},W=e=>{null==l||l(e)},T=async e=>{try{const t=`${window.location.origin}/community/posts/${e}`;navigator.share?await navigator.share({title:"分享帖子",url:t}):(await navigator.clipboard.writeText(t),alert("链接已复制到剪贴板"))}catch(t){}},U=async e=>{try{await v(e)}catch(t){}};return e("div",{className:i,children:[e("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6",children:[e("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0",children:[t("div",{className:"flex-1 max-w-md",children:e("div",{className:"relative",children:[t("input",{type:"text",value:C,onChange:e=>P(e.target.value),onKeyPress:e=>"Enter"===e.key&&E(),placeholder:"搜索帖子...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"}),t(g,{size:20,className:"absolute left-3 top-2.5 text-gray-400"}),t("button",{onClick:E,className:"absolute right-2 top-1.5 px-3 py-1 bg-orange-600 text-white text-sm rounded hover:bg-orange-700",children:"搜索"})]})}),e("div",{className:"flex items-center space-x-3",children:[e("button",{onClick:()=>z(!S),className:"flex items-center px-3 py-2 text-sm border rounded-lg "+(S?"bg-orange-50 text-orange-600 border-orange-200":"bg-white text-gray-700 border-gray-300 hover:bg-gray-50"),children:[t(u,{size:16,className:"mr-2"}),"筛选"]}),e("button",{onClick:()=>L({page:1}),disabled:d,className:"flex items-center px-3 py-2 text-sm bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50",children:[t(h,{size:16,className:"mr-2 "+(d?"animate-spin":"")}),"刷新"]}),o&&r&&e("button",{onClick:r,className:"flex items-center px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700",children:[t(p,{size:16,className:"mr-2"}),"发布帖子"]})]})]}),S&&t("div",{className:"mt-4 pt-4 border-t border-gray-200",children:e("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"分类"}),t("div",{className:"flex flex-wrap gap-2",children:y.map(t=>e("button",{onClick:()=>(e=>{const t={...w,category:e,page:1};k(t),L(t)})(t.name),className:"px-3 py-1 text-sm rounded-full border "+(w.category===t.name?"bg-orange-100 text-orange-800 border-orange-200":"bg-white text-gray-700 border-gray-300 hover:bg-gray-50"),children:[t.label," (",t.count,")"]},t.name))})]}),e("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"排序方式"}),t("select",{value:w.sort,onChange:e=>(e=>{const t={...w,sort:e,page:1};k(t),L(t)})(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500",children:[{value:"latest",label:"最新发布"},{value:"popular",label:"最多点赞"},{value:"views",label:"最多浏览"},{value:"comments",label:"最多评论"}].map(e=>t("option",{value:e.value,children:e.label},e.value))})]})]})})]}),m&&t("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6",children:e("div",{className:"flex items-center justify-between",children:[t("p",{className:"text-red-600",children:m}),t("button",{onClick:N,className:"text-red-600 hover:text-red-800",children:"×"})]})}),t("div",{className:"space-y-4",children:d&&0===c.length?e("div",{className:"text-center py-12",children:[t("div",{className:"animate-spin w-8 h-8 border-2 border-orange-600 border-t-transparent rounded-full mx-auto mb-4"}),t("p",{className:"text-gray-500",children:"加载中..."})]}):0===c.length?e("div",{className:"text-center py-12",children:[t("p",{className:"text-gray-500 mb-4",children:"暂无帖子"}),o&&r&&e("button",{onClick:r,className:"inline-flex items-center px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700",children:[t(p,{size:16,className:"mr-2"}),"发布第一个帖子"]})]}):c.map(e=>t(F,{post:e,currentUserId:null==o?void 0:o.id,onLike:M,onComment:W,onShare:T,onEdit:n,onDelete:U,onClick:l},e.id))}),(()=>{if(x.total<=1)return null;const a=[],r=Math.max(1,x.current-Math.floor(2.5)),s=Math.min(x.total,r+5-1);for(let e=r;e<=s;e++)a.push(t("button",{onClick:()=>I(e),className:"px-3 py-1 text-sm rounded "+(e===x.current?"bg-orange-600 text-white":"bg-white text-gray-700 border border-gray-300 hover:bg-gray-50"),children:e},e));return e("div",{className:"flex items-center justify-center space-x-2 mt-6",children:[t("button",{onClick:()=>I(x.current-1),disabled:1===x.current,className:"px-3 py-1 text-sm bg-white text-gray-700 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"上一页"}),a,t("button",{onClick:()=>I(x.current+1),disabled:x.current===x.total,className:"px-3 py-1 text-sm bg-white text-gray-700 border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"下一页"})]})})(),d&&c.length>0&&t("div",{className:"text-center py-4",children:t("div",{className:"animate-spin w-6 h-6 border-2 border-orange-600 border-t-transparent rounded-full mx-auto"})})]})},Y=({value:a,onChange:n,placeholder:l="请输入内容...",maxLength:o=1e4,onImageUpload:c,className:d=""})=>{const[g,u]=s.useState(!1),[h,p]=s.useState(!1),N=s.useRef(null),w=s.useRef(null),k=(e,t="")=>{const r=N.current;if(!r)return;const s=r.selectionStart,l=r.selectionEnd,i=a.substring(s,l),o=a.substring(0,s)+e+i+t+a.substring(l);n(o),setTimeout(()=>{r.focus(),r.setSelectionRange(s+e.length,s+e.length+i.length)},0)};return e("div",{className:`border border-gray-300 rounded-lg overflow-hidden ${d}`,children:[e("div",{className:"flex items-center justify-between p-2 bg-gray-50 border-b border-gray-200",children:[e("div",{className:"flex items-center space-x-2",children:[t("button",{type:"button",onClick:()=>k("**","**"),className:"p-1.5 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded",title:"粗体",children:t(x,{size:16})}),t("button",{type:"button",onClick:()=>k("*","*"),className:"p-1.5 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded",title:"斜体",children:t(y,{size:16})}),t("button",{type:"button",onClick:()=>k("\n- ",""),className:"p-1.5 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded",title:"列表",children:t(b,{size:16})}),t("button",{type:"button",onClick:()=>{const e=prompt("请输入链接地址:");e&&k("[链接文字](",`${e})`)},className:"p-1.5 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded",title:"链接",children:t(v,{size:16})}),c&&e(r,{children:[t("button",{type:"button",onClick:()=>{var e;return null==(e=w.current)?void 0:e.click()},disabled:h,className:"p-1.5 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded disabled:opacity-50",title:"插入图片",children:t(f,{size:16})}),t("input",{ref:w,type:"file",accept:"image/*",onChange:async e=>{var t;const a=null==(t=e.target.files)?void 0:t[0];if(a&&c)if(a.type.startsWith("image/"))if(a.size>10485760)alert("图片大小不能超过10MB");else{p(!0);try{const e=await c(a);k(`![图片](${e})`)}catch(r){alert("图片上传失败，请重试")}finally{p(!1),w.current&&(w.current.value="")}}else alert("请选择图片文件")},className:"hidden"})]})]}),e("div",{className:"flex items-center space-x-2",children:[e("span",{className:"text-sm text-gray-500",children:[a.length,"/",o]}),t("button",{type:"button",onClick:()=>u(!g),className:"p-1.5 rounded "+(g?"text-orange-600 bg-orange-100":"text-gray-600 hover:text-gray-800 hover:bg-gray-200"),title:g?"编辑模式":"预览模式",children:t(g?i:m,{size:16})})]})]}),e("div",{className:"relative",children:[h&&t("div",{className:"absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10",children:t("div",{className:"text-sm text-gray-600",children:"上传中..."})}),g?t("div",{className:"p-4 min-h-[200px] prose prose-sm max-w-none",dangerouslySetInnerHTML:{__html:(C=a,C.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^- (.+)$/gm,"<li>$1</li>").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>').replace(/!\[([^\]]*)\]\(([^)]+)\)/g,'<img src="$2" alt="$1" style="max-width: 100%; height: auto;" />').replace(/\n/g,"<br />"))}}):t("textarea",{ref:N,value:a,onChange:e=>n(e.target.value),placeholder:l,maxLength:o,className:"w-full p-4 min-h-[200px] resize-none border-none outline-none",style:{fontFamily:"inherit"}})]})]});var C},V=({tags:a,onChange:r,maxTags:n=10,maxTagLength:l=20,placeholder:i="添加标签...",suggestions:o=[],className:c=""})=>{const[d,m]=s.useState(""),[g,u]=s.useState(!1),[h,x]=s.useState([]),y=s.useRef(null),b=[...o,"健康","疾病","营养","训练","行为","美容","医疗","疫苗","驱虫","绝育","怀孕","幼犬","老年犬","金毛","拉布拉多","泰迪","比熊","柯基","哈士奇","英短","美短","布偶","暹罗","波斯","加菲","求助","分享","经验","推荐","咨询"];s.useEffect(()=>{if(d.trim()){const e=b.filter(e=>e.toLowerCase().includes(d.toLowerCase())&&!a.includes(e));x(e.slice(0,8)),u(e.length>0)}else x([]),u(!1)},[d,a,b]);const v=e=>{const t=e.trim();t&&!a.includes(t)&&a.length<n&&t.length<=l&&(r([...a,t]),m(""),u(!1))},f=e=>{r(a.filter(t=>t!==e))};return e("div",{className:`relative ${c}`,children:[e("div",{className:"flex flex-wrap gap-2 p-3 border border-gray-300 rounded-lg min-h-[44px] focus-within:border-orange-500 focus-within:ring-1 focus-within:ring-orange-500",children:[a.map((a,r)=>e("span",{className:"inline-flex items-center px-2 py-1 bg-orange-100 text-orange-800 text-sm rounded-full",children:[a,t("button",{type:"button",onClick:()=>f(a),className:"ml-1 text-orange-600 hover:text-orange-800",children:t(N,{size:14})})]},r)),a.length<n&&e("div",{className:"flex items-center",children:[t("input",{ref:y,type:"text",value:d,onChange:e=>{const t=e.target.value;if(t.includes(",")||t.includes(" ")){return void t.split(/[,\s]+/).filter(e=>e.trim()).forEach(e=>v(e))}m(t)},onKeyDown:e=>{"Enter"===e.key||","===e.key?(e.preventDefault(),v(d)):"Backspace"===e.key&&!d&&a.length>0?f(a[a.length-1]):"Escape"===e.key&&u(!1)},onFocus:()=>u(h.length>0),onBlur:()=>setTimeout(()=>u(!1),200),placeholder:0===a.length?i:"",className:"border-none outline-none bg-transparent text-sm min-w-[100px] flex-1",maxLength:l}),d&&t("button",{type:"button",onClick:()=>v(d),className:"ml-1 text-gray-400 hover:text-gray-600",children:t(p,{size:16})})]})]}),g&&h.length>0&&t("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto",children:h.map((e,a)=>t("button",{type:"button",onClick:()=>(e=>{var t;v(e),null==(t=y.current)||t.focus()})(e),className:"w-full px-3 py-2 text-left text-sm hover:bg-gray-100 focus:bg-gray-100 focus:outline-none",children:e},a))}),e("div",{className:"flex justify-between mt-1 text-xs text-gray-500",children:[e("span",{children:[a.length,"/",n," 个标签"]}),t("span",{children:"按回车或逗号添加标签"})]})]})},O=({post:a,pets:r=[],onSave:n,onCancel:l,onPreview:i,className:c=""})=>{const[d,g]=s.useState({title:(null==a?void 0:a.title)||"",content:(null==a?void 0:a.content)||"",petId:(null==a?void 0:a.petId)||"",category:(null==a?void 0:a.category)||"general",tags:(null==a?void 0:a.tags)||[],images:(null==a?void 0:a.images)||[]}),[u,h]=s.useState(!1),[p,x]=s.useState([]),[y,b]=s.useState({}),v=()=>{const e={};return d.title.trim()?d.title.length>200&&(e.title="标题长度不能超过200个字符"):e.title="标题不能为空",d.content.trim()?d.content.length>1e4&&(e.content="内容长度不能超过10000个字符"):e.content="内容不能为空",d.tags.length>10&&(e.tags="标签数量不能超过10个"),d.images.length>9&&(e.images="图片数量不能超过9张"),b(e),0===Object.keys(e).length},f=async e=>{const t=Math.random().toString(36).substr(2,9);x(e=>[...e,t]);try{const t=await B.uploadImage(e);if(t.success&&t.data){const e=t.data.url;return g(t=>({...t,images:[...t.images,e]})),e}throw new Error(t.message||"图片上传失败")}finally{x(e=>e.filter(e=>e!==t))}};return e("div",{className:`bg-white rounded-lg shadow-sm border border-gray-200 ${c}`,children:[e("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[t("h2",{className:"text-lg font-semibold text-gray-900",children:a?"编辑帖子":"发布新帖子"}),t("button",{onClick:l,className:"text-gray-400 hover:text-gray-600",children:t(N,{size:20})})]}),e("div",{className:"p-4 space-y-4",children:[e("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"标题 *"}),t("input",{type:"text",value:d.title,onChange:e=>g(t=>({...t,title:e.target.value})),placeholder:"请输入帖子标题...",maxLength:200,className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 "+(y.title?"border-red-500":"border-gray-300")}),y.title&&t("p",{className:"mt-1 text-sm text-red-600",children:y.title}),e("p",{className:"mt-1 text-sm text-gray-500",children:[d.title.length,"/200"]})]}),e("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"分类"}),t("select",{value:d.category,onChange:e=>g(t=>({...t,category:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500",children:[{value:"general",label:"日常分享"},{value:"health",label:"健康分享"},{value:"help",label:"求助问答"},{value:"experience",label:"经验分享"}].map(e=>t("option",{value:e.value,children:e.label},e.value))})]}),r.length>0&&e("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"相关宠物"}),e("select",{value:d.petId,onChange:e=>g(t=>({...t,petId:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500",children:[t("option",{value:"",children:"选择宠物（可选）"}),r.map(t=>e("option",{value:t.id,children:[t.name," (","dog"===t.type?"狗":"cat"===t.type?"猫":"其他",")"]},t.id))]})]})]}),e("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"内容 *"}),t(Y,{value:d.content,onChange:e=>g(t=>({...t,content:e})),placeholder:"分享你的想法、经验或问题...",maxLength:1e4,onImageUpload:f,className:y.content?"border-red-500":""}),y.content&&t("p",{className:"mt-1 text-sm text-red-600",children:y.content})]}),e("div",{children:[e("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["图片 (",d.images.length,"/9)"]}),d.images.length>0&&t("div",{className:"grid grid-cols-3 gap-2 mb-3",children:d.images.map((a,r)=>e("div",{className:"relative group",children:[t("img",{src:a,alt:`图片 ${r+1}`,className:"w-full h-24 object-cover rounded-lg"}),t("button",{type:"button",onClick:()=>(e=>{g(t=>({...t,images:t.images.filter(t=>t!==e)}))})(a),className:"absolute top-1 right-1 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity",children:t(o,{size:12})})]},r))}),d.images.length<9&&e("div",{children:[t("input",{type:"file",multiple:!0,accept:"image/*",onChange:async e=>{const t=Array.from(e.target.files||[]);for(const r of t){if(d.images.length>=9){alert("最多只能上传9张图片");break}if(r.type.startsWith("image/"))if(r.size>10485760)alert(`${r.name} 文件大小超过10MB`);else try{await f(r)}catch(a){alert(`${r.name} 上传失败`)}else alert(`${r.name} 不是有效的图片文件`)}e.target.value=""},className:"hidden",id:"image-upload"}),e("label",{htmlFor:"image-upload",className:"inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 cursor-pointer",children:[t(w,{size:16,className:"mr-2"}),"上传图片"]}),p.length>0&&e("span",{className:"ml-2 text-sm text-gray-500",children:["上传中... (",p.length,")"]})]}),y.images&&t("p",{className:"mt-1 text-sm text-red-600",children:y.images})]}),e("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"标签"}),t(V,{tags:d.tags,onChange:e=>g(t=>({...t,tags:e})),maxTags:10,placeholder:"添加相关标签..."}),y.tags&&t("p",{className:"mt-1 text-sm text-red-600",children:y.tags})]})]}),e("div",{className:"flex items-center justify-between p-4 border-t border-gray-200 bg-gray-50",children:[t("div",{className:"text-sm text-gray-500",children:"* 为必填项"}),e("div",{className:"flex items-center space-x-3",children:[i&&e("button",{type:"button",onClick:()=>{v()&&(null==i||i(d))},className:"inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50",children:[t(m,{size:16,className:"mr-2"}),"预览"]}),t("button",{type:"button",onClick:l,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50",children:"取消"}),e("button",{type:"button",onClick:async()=>{if(v()){h(!0);try{await n(d)}catch(e){}finally{h(!1)}}},disabled:u,className:"inline-flex items-center px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed",children:[t(k,{size:16,className:"mr-2"}),u?"保存中...":a?"更新":"发布"]})]})]})]})},K=({comment:a,currentUserId:r,onLike:n,onReply:i,onDelete:c,onReport:d,isReply:m=!1,className:g=""})=>{var u,h,p,x,y;const[b,v]=s.useState(!1),[f,N]=s.useState(!1),w=r===a.userId,k=!!r&&a.likes.includes(r);return a.isDeleted?t("div",{className:`${m?"ml-8 mt-3":"mb-4"} ${g}`,children:t("div",{className:"text-gray-400 text-sm italic py-2",children:"此评论已被删除"})}):e("div",{className:`${m?"ml-8 mt-3":"mb-4"} ${g}`,children:[e("div",{className:"flex space-x-3",children:[t("div",{className:"w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center flex-shrink-0",children:(null==(u=a.user)?void 0:u.avatar)?t("img",{src:a.user.avatar,alt:a.user.username,className:"w-8 h-8 rounded-full object-cover"}):t("span",{className:"text-orange-600 text-sm font-medium",children:(null==(x=null==(p=null==(h=a.user)?void 0:h.username)?void 0:p.charAt(0))?void 0:x.toUpperCase())||"U"})}),e("div",{className:"flex-1",children:[e("div",{className:"flex items-center justify-between mb-1",children:[e("div",{className:"flex items-center space-x-2",children:[t("span",{className:"font-medium text-gray-900",children:(null==(y=a.user)?void 0:y.username)||"匿名用户"}),t("span",{className:"text-sm text-gray-500",children:I(new Date(a.createdAt),{addSuffix:!0,locale:A})}),"pending"===a.moderationStatus&&t("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full",children:"审核中"})]}),(w||d)&&e("div",{className:"relative",children:[t("button",{onClick:e=>{e.stopPropagation(),v(!b)},className:"p-1 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100",children:t(l,{size:14})}),b&&e("div",{className:"absolute right-0 top-6 w-32 bg-white border border-gray-200 rounded-lg shadow-lg z-10",children:[w&&c&&e("button",{onClick:e=>{e.stopPropagation(),(async()=>{if(c&&confirm("确定要删除这条评论吗？")){N(!0);try{await c(a.id)}catch(e){}finally{N(!1)}}})(),v(!1)},disabled:f,className:"w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center disabled:opacity-50",children:[t(o,{size:12,className:"mr-2"}),f?"删除中...":"删除"]}),!w&&d&&e("button",{onClick:e=>{e.stopPropagation(),d&&(r?d(a.id):alert("请先登录")),v(!1)},className:"w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center",children:[t(C,{size:12,className:"mr-2"}),"举报"]})]})]})]}),t("div",{className:"text-gray-700 text-sm mb-2 leading-relaxed",dangerouslySetInnerHTML:{__html:(P=a.content,P.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="text-orange-600 hover:text-orange-700 underline">$1</a>').replace(/\n/g,"<br />"))}}),e("div",{className:"flex items-center space-x-4",children:[t(_,{isLiked:k,likesCount:a.likesCount||a.likes.length,onToggle:async()=>{r?await n(a.id):alert("请先登录")},size:"sm"}),r&&t("button",{onClick:()=>{var e;r?i(a.id,(null==(e=a.user)?void 0:e.username)||"用户"):alert("请先登录")},className:"text-xs text-gray-500 hover:text-orange-600 transition-colors",children:"回复"})]}),a.replies&&a.replies.length>0&&t("div",{className:"mt-3",children:a.replies.map(e=>t(K,{comment:e,currentUserId:r,onLike:n,onReply:i,onDelete:c,onReport:d,isReply:!0},e.id))})]})]}),b&&t("div",{className:"fixed inset-0 z-5",onClick:()=>v(!1)})]});var P},Q=({comments:a,currentUserId:r,currentUserAvatar:n,currentUserUsername:l,totalComments:i,loading:o=!1,hasMore:c=!1,onLoadMore:d,onCreateComment:m,onLikeComment:g,onDeleteComment:u,onReportComment:h,className:p=""})=>{var x;const[y,b]=s.useState(""),[v,f]=s.useState(!1),[N,w]=s.useState(null),k=(e,t)=>{w({id:e,username:t}),b(`@${t} `)};return t("div",{className:`bg-white rounded-lg shadow-sm border border-gray-200 ${p}`,children:e("div",{className:"p-6",children:[e("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:["评论 (",i,")"]}),e("div",r?{className:"mb-6",children:[N&&e("div",{className:"mb-2 text-sm text-gray-500 flex items-center justify-between",children:[e("span",{children:["回复 @",N.username]}),t("button",{onClick:()=>{w(null),b("")},className:"text-orange-600 hover:text-orange-700",children:"取消"})]}),e("div",{className:"flex space-x-3",children:[t("div",{className:"w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center flex-shrink-0",children:n?t("img",{src:n,alt:l,className:"w-8 h-8 rounded-full object-cover"}):t("span",{className:"text-orange-600 text-sm font-medium",children:(null==(x=null==l?void 0:l.charAt(0))?void 0:x.toUpperCase())||"U"})}),e("div",{className:"flex-1",children:[t("textarea",{value:y,onChange:e=>b(e.target.value),placeholder:N?`回复 @${N.username}...`:"写下你的评论...",rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 resize-none",maxLength:2e3}),e("div",{className:"flex items-center justify-between mt-2",children:[e("span",{className:"text-sm text-gray-500",children:[y.length,"/2000"]}),e("button",{onClick:async()=>{if(r)if(y.trim()){f(!0);try{await m(y.trim(),null==N?void 0:N.id),b(""),w(null)}catch(e){}finally{f(!1)}}else alert("请输入评论内容");else alert("请先登录")},disabled:!y.trim()||v,className:"inline-flex items-center px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[t(P,{size:16,className:"mr-2"}),v?"发布中...":"发布评论"]})]})]})]})]}:{className:"mb-6 p-4 bg-gray-50 rounded-lg text-center",children:[t("p",{className:"text-gray-600 mb-2",children:"登录后可以发表评论"}),t("button",{onClick:()=>window.location.href="/login",className:"text-orange-600 hover:text-orange-700 font-medium",children:"立即登录"})]}),t("div",{children:o&&0===a.length?e("div",{className:"text-center py-8",children:[t("div",{className:"animate-spin w-6 h-6 border-2 border-orange-600 border-t-transparent rounded-full mx-auto mb-2"}),t("p",{className:"text-gray-500 text-sm",children:"加载评论中..."})]}):0===a.length?t("div",{className:"text-center py-8",children:t("p",{className:"text-gray-500",children:"暂无评论，来发表第一个评论吧！"})}):e("div",{children:[a.map(e=>t(K,{comment:e,currentUserId:r,onLike:g,onReply:k,onDelete:u,onReport:h},e.id)),c&&t("div",{className:"text-center mt-6",children:t("button",{onClick:d,disabled:o,className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 disabled:opacity-50 transition-colors",children:o?"加载中...":"加载更多评论"})})]})})]})})},Z=({postId:r,onBack:n,onEdit:o,className:g=""})=>{var u,h,p,x,y;const{user:b}=a(),{toggleLikePost:v}=q(),{post:f,comments:N,loading:w,error:k,commentsPagination:C,fetchPost:P,fetchComments:z,createComment:$,toggleLikeComment:j}=(e=>{const[t,a]=s.useState(null),[r,n]=s.useState([]),[l,i]=s.useState(!1),[o,c]=s.useState(null),[d,m]=s.useState({current:1,total:0,pageSize:20,totalItems:0}),g=s.useCallback(async e=>{var t,r;i(!0),c(null);try{const t=await B.getPost(e);t.success&&t.data?a(t.data):c(t.message||"获取帖子详情失败")}catch(s){c((null==(r=null==(t=s.response)?void 0:t.data)?void 0:r.message)||"获取帖子详情失败")}finally{i(!1)}},[]),u=s.useCallback(async(e,t=1)=>{var a,r;i(!0),c(null);try{const a=await B.getComments(e,t);a.success&&a.data?(n(1===t?a.data.comments:e=>[...e,...a.data.comments]),m(a.data.pagination)):c(a.message||"获取评论失败")}catch(s){c((null==(r=null==(a=s.response)?void 0:a.data)?void 0:r.message)||"获取评论失败")}finally{i(!1)}},[]),h=s.useCallback(async(e,t)=>{var a,r;i(!0),c(null);try{const a=await B.createComment(e,t);if(a.success&&a.data)return n(e=>[...e,a.data]),a.data;throw new Error(a.message||"发布评论失败")}catch(s){const e=(null==(r=null==(a=s.response)?void 0:a.data)?void 0:r.message)||s.message||"发布评论失败";throw c(e),new Error(e)}finally{i(!1)}},[]),p=s.useCallback(async e=>{var t,a;try{const t=await B.toggleLikeComment(e);if(t.success&&t.data)return n(a=>a.map(a=>a.id===e?{...a,likesCount:t.data.likesCount,likes:t.data.isLiked?[...a.likes,"current-user"]:a.likes.filter(e=>"current-user"!==e)}:a)),t.data;throw new Error(t.message||"点赞操作失败")}catch(r){const e=(null==(a=null==(t=r.response)?void 0:t.data)?void 0:a.message)||r.message||"点赞操作失败";throw c(e),new Error(e)}},[]);return s.useEffect(()=>{e&&(g(e),u(e))},[e,g,u]),{post:t,comments:r,loading:l,error:o,commentsPagination:d,fetchPost:g,fetchComments:u,createComment:h,toggleLikeComment:p,clearError:()=>c(null)}})(r),[L,E]=s.useState(!1),M=b&&f&&b.id===f.userId,W=!(!b||!f)&&f.interactions.likes.includes(b.id);return w&&!f?e("div",{className:"text-center py-12",children:[t("div",{className:"animate-spin w-8 h-8 border-2 border-orange-600 border-t-transparent rounded-full mx-auto mb-4"}),t("p",{className:"text-gray-500",children:"加载中..."})]}):k?e("div",{className:"text-center py-12",children:[t("p",{className:"text-red-600 mb-4",children:k}),t("button",{onClick:()=>P(r),className:"px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700",children:"重试"})]}):f?e("div",{className:`max-w-4xl mx-auto ${g}`,children:[e("div",{className:"flex items-center justify-between mb-6",children:[e("button",{onClick:n,className:"flex items-center text-gray-600 hover:text-gray-800",children:[t(S,{size:20,className:"mr-2"}),"返回列表"]}),M&&e("div",{className:"relative",children:[t("button",{onClick:()=>E(!L),className:"p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100",children:t(l,{size:20})}),L&&t("div",{className:"absolute right-0 top-10 w-32 bg-white border border-gray-200 rounded-lg shadow-lg z-10",children:e("button",{onClick:()=>{null==o||o(f),E(!1)},className:"w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center",children:[t(i,{size:14,className:"mr-2"}),"编辑"]})})]})]}),e("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 mb-6",children:[e("div",{className:"p-6 border-b border-gray-200",children:[t("div",{className:"flex items-start justify-between mb-4",children:e("div",{className:"flex items-center space-x-3",children:[t("div",{className:"w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center",children:(null==(u=f.user)?void 0:u.avatar)?t("img",{src:f.user.avatar,alt:f.user.username,className:"w-12 h-12 rounded-full object-cover"}):t("span",{className:"text-orange-600 font-medium text-lg",children:(null==(x=null==(p=null==(h=f.user)?void 0:h.username)?void 0:p.charAt(0))?void 0:x.toUpperCase())||"U"})}),e("div",{children:[t("h4",{className:"font-medium text-gray-900",children:(null==(y=f.user)?void 0:y.username)||"匿名用户"}),t("p",{className:"text-sm text-gray-500",children:I(new Date(f.createdAt),{addSuffix:!0,locale:A})})]})]})}),t("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:f.title}),e("div",{className:"flex flex-wrap items-center gap-2 mb-4",children:[t("span",{className:"px-3 py-1 bg-orange-100 text-orange-800 text-sm rounded-full",children:"health"===f.category?"健康分享":"help"===f.category?"求助问答":"experience"===f.category?"经验分享":"日常分享"}),f.tags.map((t,a)=>e("span",{className:"px-2 py-1 bg-gray-100 text-gray-600 text-sm rounded-full",children:["#",t]},a))]})]}),e("div",{className:"p-6",children:[t("div",{className:"prose prose-sm max-w-none text-gray-700",dangerouslySetInnerHTML:{__html:(T=f.content,T.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/^- (.+)$/gm,"<li>$1</li>").replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer" class="text-orange-600 hover:text-orange-700 underline">$1</a>').replace(/!\[([^\]]*)\]\(([^)]+)\)/g,'<img src="$2" alt="$1" class="max-w-full h-auto rounded-lg my-2" />').replace(/\n/g,"<br />"))}}),f.images&&f.images.length>0&&t("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6",children:f.images.map((e,a)=>t("img",{src:e,alt:`图片 ${a+1}`,className:"w-full h-48 object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>{}},a))})]}),t("div",{className:"px-6 py-4 border-t border-gray-200 bg-gray-50",children:e("div",{className:"flex items-center justify-between",children:[e("div",{className:"flex items-center space-x-6",children:[t(_,{isLiked:W,likesCount:f.likesCount||f.interactions.likes.length,onToggle:async()=>{if(b)try{await v(r),await P(r)}catch(e){}else alert("请先登录")},size:"lg"}),e("div",{className:"flex items-center space-x-2 text-gray-500",children:[t(d,{size:20}),t("span",{children:f.commentsCount||f.comments.length})]}),e("button",{onClick:async()=>{try{const e=window.location.href;navigator.share?await navigator.share({title:null==f?void 0:f.title,text:null==f?void 0:f.content.substring(0,100),url:e}):(await navigator.clipboard.writeText(e),alert("链接已复制到剪贴板"))}catch(e){}},className:"flex items-center space-x-2 text-gray-500 hover:text-green-600 transition-colors",children:[t(c,{size:20}),t("span",{children:"分享"})]})]}),e("div",{className:"flex items-center space-x-2 text-gray-400",children:[t(m,{size:16}),t("span",{children:f.interactions.views})]})]})})]}),t(Q,{comments:N,currentUserId:null==b?void 0:b.id,currentUserAvatar:null==b?void 0:b.avatar,currentUserUsername:null==b?void 0:b.username,totalComments:C.totalItems,loading:w,hasMore:C.current<C.total,onLoadMore:()=>z(r,C.current+1),onCreateComment:async(e,t)=>{await $(r,{content:e,parentId:t})},onLikeComment:async e=>{await j(e)}}),L&&t("div",{className:"fixed inset-0 z-5",onClick:()=>E(!1)})]}):t("div",{className:"text-center py-12",children:t("p",{className:"text-gray-500",children:"帖子不存在"})});var T},G=()=>{const{user:r}=a(),{pets:n}=W(),{createPost:l,updatePost:i}=q(),[o,c]=s.useState("list"),[d,m]=s.useState(null),[g,u]=s.useState(null),h=e=>{m(e),c("edit")},p=()=>{c("list"),m(null),u(null)};return t("div",{className:"min-h-screen bg-gray-50",children:e("div",{className:"container mx-auto px-4 py-8",children:[e("div",{className:"mb-8",children:[t("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"宠物社区"}),t("p",{className:"text-gray-600",children:"分享你的养宠经验，与其他宠物主人交流互动"})]}),"list"===o&&t(H,{onCreatePost:()=>{r?(m(null),c("create")):alert("请先登录")},onEditPost:h,onViewPost:e=>{u(e),c("detail")}}),("create"===o||"edit"===o)&&t("div",{className:"max-w-4xl mx-auto",children:t(O,{post:d||void 0,pets:n,onSave:async e=>{try{d?await i(d.id,e):await l(e),c("list"),m(null)}catch(t){throw t}},onCancel:p,onPreview:e=>{}})}),"detail"===o&&g&&t(Z,{postId:g,onBack:p,onEdit:h})]})})};export{G as default};
