# 用户认证测试套件

## 概述

本目录包含完善的用户认证测试套件，涵盖注册、登录、密码管理等核心认证功能的全面测试。

## 测试文件结构

```
specs/auth/
├── README.md                           # 本文档
├── index.ts                           # 测试套件索引
├── registration-extended.spec.ts      # 扩展注册流程测试
├── login-enhanced.spec.ts            # 增强登录功能测试
└── password-management.spec.ts       # 密码管理测试
```

## 测试覆盖内容

### 1. 扩展注册流程测试 (`registration-extended.spec.ts`)

#### 邮箱验证测试
- ✅ 邮箱格式验证
- ✅ 邮箱重复检测
- ✅ 邮箱大小写不敏感检查
- ✅ 邮箱长度限制验证

#### 密码强度验证测试
- ✅ 密码最小长度验证
- ✅ 密码复杂度要求验证
- ✅ 强密码指示器显示
- ✅ 密码确认匹配验证
- ✅ 密码最大长度验证
- ✅ 常见弱密码禁止

#### 用户名重复检查测试
- ✅ 用户名重复检测
- ✅ 用户名大小写敏感检查
- ✅ 用户名格式要求验证
- ✅ 实时用户名可用性检查

#### 注册表单验证测试
- ✅ 必填字段错误显示
- ✅ 服务条款同意验证
- ✅ 表单字段自动完成
- ✅ 键盘导航支持
- ✅ Enter键提交表单

#### 注册错误提示测试
- ✅ 服务器错误提示
- ✅ 网络错误提示
- ✅ 请求超时提示
- ✅ 错误消息自动消失

#### 注册成功后用户状态验证测试
- ✅ 页面跳转验证
- ✅ 用户登录状态验证
- ✅ 用户信息显示验证
- ✅ 欢迎消息显示
- ✅ 用户权限和功能访问验证
- ✅ 用户会话持久性验证
- ✅ 新用户引导流程验证

#### 注册表单交互测试
- ✅ 密码可见性切换
- ✅ 表单数据保存和恢复
- ✅ 表单重置功能

#### 注册性能测试
- ✅ 注册时间性能验证
- ✅ 注册进度指示器显示

### 2. 增强登录功能测试 (`login-enhanced.spec.ts`)

#### 记住登录状态测试
- ✅ 记住登录状态功能
- ✅ 新会话中保持登录状态
- ✅ 不选择记住我时的行为
- ✅ 记住我状态过期处理

#### 自动登录测试
- ✅ 页面刷新后自动登录
- ✅ token有效期内自动续期
- ✅ 自动登录失败处理

#### 登录失败重试和账户锁定测试
- ✅ 登录失败次数记录
- ✅ 达到最大失败次数后账户锁定
- ✅ 账户锁定倒计时显示
- ✅ 账户解锁后正常登录
- ✅ 管理员解锁账户
- ✅ 邮箱验证解锁账户

#### 多设备登录和会话管理测试
- ✅ 多设备同时登录
- ✅ 活跃会话列表显示
- ✅ 远程登出其他设备
- ✅ 单个会话登出
- ✅ 会话详细信息显示
- ✅ 可疑登录检测
- ✅ 会话超时自动登出

#### 登录安全功能测试
- ✅ 两步验证登录
- ✅ 验证码重新发送
- ✅ 备用验证码登录
- ✅ 登录历史记录
- ✅ 登录通知

#### 登录用户体验测试
- ✅ 社交媒体登录
- ✅ 快速登录选项
- ✅ 登录表单自动完成
- ✅ 登录状态保存提示

### 3. 密码管理测试 (`password-management.spec.ts`)

#### 密码重置测试
- ✅ 通过邮箱重置密码
- ✅ 重置邮箱地址格式验证
- ✅ 不存在邮箱地址处理
- ✅ 重置链接过期处理
- ✅ 重置链接使用次数限制
- ✅ 新密码设置
- ✅ 新密码强度要求验证
- ✅ 新密码确认匹配验证
- ✅ 重置频率限制

#### 修改密码测试
- ✅ 修改密码功能
- ✅ 当前密码正确性验证
- ✅ 新密码不能与当前密码相同验证
- ✅ 密码强度实时检查
- ✅ 密码可见性切换
- ✅ 密码修改确认对话框

#### 密码安全策略验证测试
- ✅ 密码长度要求验证
- ✅ 密码复杂度要求验证
- ✅ 常见弱密码禁止
- ✅ 密码字符集要求验证
- ✅ 密码强度评分

#### 密码历史和过期检查测试
- ✅ 防止重复使用最近密码
- ✅ 密码历史记录数量显示
- ✅ 密码过期检查
- ✅ 强制过期密码更新
- ✅ 密码年龄信息显示
- ✅ 密码强度历史跟踪
- ✅ 密码策略配置查看

#### 密码安全事件测试
- ✅ 密码修改事件记录
- ✅ 密码重置事件记录
- ✅ 密码修改通知发送
- ✅ 可疑密码活动检测
- ✅ 密码泄露检查

#### 密码管理用户体验测试
- ✅ 密码生成器
- ✅ 密码强度提示
- ✅ 密码输入辅助功能
- ✅ 密码复制功能

## 需求覆盖

本测试套件覆盖以下需求：

- **需求1.1**: 核心功能测试覆盖 - 用户认证、宠物管理、便便分析、社区功能的完整流程
- **需求3.3**: 错误处理和边界情况测试 - 表单输入无效时显示实时验证提示

## 运行测试

### 运行所有认证测试
```bash
npx playwright test specs/auth/
```

### 运行特定测试文件
```bash
# 注册流程测试
npx playwright test specs/auth/registration-extended.spec.ts

# 登录功能测试
npx playwright test specs/auth/login-enhanced.spec.ts

# 密码管理测试
npx playwright test specs/auth/password-management.spec.ts
```

### 运行特定测试组
```bash
# 运行邮箱验证相关测试
npx playwright test --grep "邮箱验证测试"

# 运行密码强度相关测试
npx playwright test --grep "密码强度"

# 运行会话管理相关测试
npx playwright test --grep "会话管理"
```

### 调试模式运行
```bash
npx playwright test specs/auth/ --debug
```

### 生成测试报告
```bash
npx playwright test specs/auth/ --reporter=html
```

## 测试数据管理

测试使用 `TestDataManager` 类来管理测试数据：

- 自动创建测试用户和相关数据
- 测试完成后自动清理数据
- 支持并行测试执行
- 提供数据模板和随机数据生成

## 依赖组件

- **AuthPage**: 认证页面对象，提供认证相关操作方法
- **TestDataManager**: 测试数据管理器，负责创建和清理测试数据
- **APIMocker**: API模拟器，用于模拟各种API响应和错误情况

## 测试环境要求

- 测试数据库应该与生产数据库隔离
- 需要支持并行测试执行
- 测试完成后应该自动清理测试数据
- 需要配置适当的超时时间和重试策略

## 维护说明

1. **添加新测试**: 在相应的测试文件中添加新的测试用例
2. **更新页面对象**: 如果UI发生变化，需要更新 `AuthPage` 类中的选择器
3. **数据清理**: 确保所有测试都正确使用 `TestDataManager` 进行数据清理
4. **错误处理**: 为新的错误场景添加相应的模拟和测试用例

## 性能考虑

- 测试设计为并行执行，提高测试效率
- 使用数据模板减少重复的数据创建操作
- 合理设置超时时间，避免测试卡死
- 在CI环境中使用最小浏览器配置以提高速度

## 贡献指南

1. 遵循现有的测试结构和命名约定
2. 为每个测试用例添加清晰的描述
3. 确保测试的独立性和可重复性
4. 添加适当的错误处理和边界条件测试
5. 更新相关文档和注释

---

**总计**: 80+ 个测试用例，覆盖用户认证的各个方面，确保系统的安全性和可靠性。